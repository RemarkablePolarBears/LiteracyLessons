from pathlib import Path

# Define the corrected HTML template
html_template = """<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Obsidian Canvas Export</title>
  <style>
    :root {
      --font-family: "Helvetica Neue", Arial, sans-serif;
      --transition-duration: 0.3s;
    }
    body {
      margin: 0; overflow: hidden;
      font-family: var(--font-family);
      background: #fafafa;
    }
    #controls {
      position: fixed; top: 10px; left: 10px;
      background: rgba(255,255,255,0.8); padding: 8px;
      border-radius: 4px; z-index: 1000;
    }
    #controls button, #controls label {
      margin-right: 8px; cursor: pointer;
    }
    #canvas-container {
      width: 100vw; height: 100vh;
      position: relative; overflow: hidden;
    }
    #link-layer {
      position: absolute; top:0; left:0;
      width:100%; height:100%; pointer-events:none;
    }
    #nodes-container {
      position: absolute; top:0; left:0;
      transform-origin: 0 0;
    }
    .canvas-node {
      position: absolute;
      padding: 8px;
      border: 1px solid #888;
      background: #fff;
      color: #333;
      border-radius: 6px;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
      transition: transform var(--transition-duration),
                  opacity var(--transition-duration);
      opacity: 0;
      transform: scale(0.8);
    }
    .canvas-node.expanded {
      transform: scale(1.1);
      z-index: 500;
    }
    .canvas-node.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="toggle-theme">切換主題</button>
    <span>篩選類別：</span>
    <span id="filters"></span>
  </div>
  <div id="canvas-container">
    <svg id="link-layer"></svg>
    <div id="nodes-container"></div>
  </div>

  <script id="canvas-data" type="application/json">
  {
    // 將從 Canvas 匯出的 JSON 貼在此處
  }
  </script>

  <script src="https://unpkg.com/panzoom@9.4.0/dist/panzoom.min.js"></script>
  <script>
  (function(){
    const data = JSON.parse(document.getElementById("canvas-data").textContent);
    const nodesContainer = document.getElementById("nodes-container");
    const linkLayer = document.getElementById("link-layer");
    const filtersEl = document.getElementById("filters");

    const categories = [...new Set(
      data.nodes.map(n => n.data?.category || "未分類")
    )];

    categories.forEach(cat => {
      const lab = document.createElement("label");
      const chk = document.createElement("input");
      chk.type = "checkbox"; chk.checked = true;
      chk.value = cat;
      chk.addEventListener("change", applyFilter);
      lab.appendChild(chk);
      lab.appendChild(document.createTextNode(cat));
      filtersEl.appendChild(lab);
    });

    data.nodes.forEach(n => {
      const d = document.createElement("div");
      d.className = "canvas-node";
      d.style.left = n.x + "px";
      d.style.top  = n.y + "px";
      d.style.width  = n.width + "px";
      d.style.height = n.height + "px";
      d.innerHTML = n.text.replace(/\\n/g, "<br>");
      d.dataset.category = n.data?.category || "未分類";
      d.addEventListener("click", ()=>{ d.classList.toggle("expanded"); });
      nodesContainer.appendChild(d);
      requestAnimationFrame(()=>{
        d.style.opacity = 1;
        d.style.transform = "scale(1)";
      });
    });

    data.connections.forEach(c => {
      const src = data.nodes.find(n=>n.id===c.source);
      const tgt = data.nodes.find(n=>n.id===c.target);
      if (src && tgt) {
        const line = document.createElementNS("http://www.w3.org/2000/svg","line");
        const x1=src.x+src.width/2, y1=src.y+src.height/2;
        const x2=tgt.x+tgt.width/2, y2=tgt.y+tgt.height/2;
        line.setAttribute("x1",x1);
        line.setAttribute("y1",y1);
        line.setAttribute("x2",x2);
        line.setAttribute("y2",y2);
        line.setAttribute("stroke","#666");
        line.setAttribute("stroke-width","2");
        linkLayer.appendChild(line);
      }
    });

    function applyFilter(){
      const active = new Set(
        [...filtersEl.querySelectorAll("input")]
          .filter(i=>i.checked).map(i=>i.value)
      );
      nodesContainer.querySelectorAll(".canvas-node")
        .forEach(d=>{
          d.classList.toggle("hidden", !active.has(d.dataset.category));
        });
    }

    panzoom(nodesContainer, { smoothScroll: false });

    document.getElementById("toggle-theme")
      .addEventListener("click", ()=>{
        document.body.classList.toggle("theme-dark");
        document.body.style.background = document.body.classList.contains("theme-dark") ? "#2e2e2e" : "#fafafa";
      });
  })();
  </script>
</body>
</html>
"""

# Write the new HTML file
output_path = Path('/mnt/data/LiteracyLessonCanvas.html')
output_path.write_text(html_template, encoding='utf-8')

output_path
